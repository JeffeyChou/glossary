合并---
title: 2-5-拟牛顿法
date: 2022-10-25 08:58:16
excerpt: 
tags: 最优化算法 拟牛顿法 牛顿法
rating: ⭐
status: complete 
destination: 03-05
share: false
obsidianUIMode: source
---
- **牛顿法的缺陷**:
1. 当目标函数为一般性的非线性函数时，牛顿法不能保证能够从任意起始点 $\boldsymbol{x}^{(0)}$ 收敛到函数的极小点。
2. 必须计算黑塞矩阵 $\boldsymbol{F}(\boldsymbol{x}^{(k)})$  和求解方程 $\boldsymbol{F}(\boldsymbol{x}^{(k)})\boldsymbol{d}^{(k)}=- \boldsymbol{g}^{(k)}$ 上进行一维搜索。
3. 黑塞矩阵是非正定或奇异的。
- **拟牛顿法的思路**：
设计黑塞矩阵的近似矩阵来代替黑塞矩阵。此时需要用到目标函数值和梯度。令 $\boldsymbol{H}_{0}, \boldsymbol{H}_{1}, \boldsymbol{H}_{2}, …$ 表示对应黑塞矩阵的逆的一系列近似矩阵。
则 $\boldsymbol{H}_{k}$ 满足：
1. 对称正定。(保证函数值迭代后下降)
2. 从$\boldsymbol{H}_{k-1}$ 到 $\boldsymbol{H}_{k}$ 计算量较小。
3. $\boldsymbol{H}_{k}$ 与对应的黑塞矩阵近似。
---
分析: 黑塞矩阵性质 (即二阶导)：
1维：近似计算 $f^{\prime \prime}\left(x^{(k)}\right): \frac{f^{\prime}\left(x^{(k)}\right)-f^{\prime}\left(x^{(k-1)}\right)}{x^{(k)}-x^{(k-1)}}$ $$f^{\prime}\left(x^{(k-1)}\right) \approx f^{\prime}\left(x^{(k)}\right)+f^{\prime \prime}\left(x^{(k)}\right)\left(x^{(k-1)}-x^{(k)}\right)$$
n维: $$\nabla f\left(x^{(k-1)}\right) \approx \nabla f\left(x^{(k)}\right)+\nabla^2 f\left(x^{(k)}\right)\left(x^{(k-1)}-x^{(k)}\right)$$ 记 $$\Delta g^{(k-1)}=\nabla f\left(x^{(k-1)}\right)-\nabla f\left(x^{(k)}\right), \quad \Delta x^{(k-1)}=x^{(k-1)}-x^{(k)}$$
简化为: $$\Delta g^{(k-1)} \approx \nabla^2 f\left(x^{(k)}\right) \Delta x^{(k-1)}$$ 或 $$\left[\nabla^2 f\left(x^{(k)}\right)\right]^{-1} \Delta g^{(k-1)} \approx \Delta x^{(k-1)}$$
因此：$$
\boldsymbol{H}_{k}\Delta\boldsymbol{g}^{(k-1)} = \Delta \boldsymbol{x}^{(k-1)}$$
- **拟牛顿法迭代公式**:
$$
\begin{aligned}
\boldsymbol{d}^{(k)} &=-\boldsymbol{H}_k \boldsymbol{g}^{(k)} \\
\alpha_k &=\underset{\alpha \geqslant 0}{\arg \min } f\left(\boldsymbol{x}^{(k)}+\alpha \boldsymbol{d}^{(k)}\right) \\
\boldsymbol{x}^{(k+1)} &=\boldsymbol{x}^{(k)}+\alpha_k \boldsymbol{d}^{(k)}
\end{aligned}
$$
其中, 矩阵 $\boldsymbol{H}_0, \boldsymbol{H}_1, \boldsymbol{H}_2, \cdots$ 是对称矩阵。目标函数为二次型函数时, 它们必须满足
$$
\boldsymbol{H}_{k+1} \Delta \boldsymbol{g}^{(i)}=\Delta \boldsymbol{x}^{(i)}, \quad 0 \leqslant i \leqslant k
$$
其中, $\Delta \boldsymbol{x}^{(i)}=\boldsymbol{x}^{(i+1)}-\boldsymbol{x}^{(i)}=\alpha_i \boldsymbol{d}^{(i)}, \Delta \boldsymbol{g}^{(i)}=\boldsymbol{g}^{(i+1)}-\boldsymbol{g}^{(i)}=\boldsymbol{Q} \Delta \boldsymbol{x}^{(i)}$ 。实际上, 拟牛顿法也是 一种共轭方向法, 接下来给出证明。
- **定理 11. 1**:
 将拟牛顿法应用到二次型问题中, 黑塞矩阵为 $\boldsymbol{Q}=\boldsymbol{Q}^{\top}$, 对于 $0 \leqslant k<n-1$, 有
$$
\boldsymbol{H}_{k+1} \Delta \boldsymbol{g}^{(i)}=\Delta \boldsymbol{x}^{(i)}, \quad 0 \leqslant i \leqslant k
$$
 其中, $\boldsymbol{H}_{k+1}=\boldsymbol{H}_{k+1}^{\top}$ 。 如果 $\alpha_i \neq 0,0 \leqslant i \leqslant k$, 那么 $\boldsymbol{d}^{(0)}, \boldsymbol{d}^{(1)}, \cdots, \boldsymbol{d}^{(k+1)}$ 是 $\boldsymbol{Q}$ 共轭的。

从矩阵 $\boldsymbol{H}_{k}$ 必须满足的方程来看，$\boldsymbol{H}_{k}$ 并不能唯一确定，常见的矩阵$\boldsymbol{H}_{k+1}$ 是通过在矩阵 $\boldsymbol{H}_{k}$ 上增加一个修正项来得到。

---
### 秩1修正公式
 $$\boldsymbol{H}_{k+1}=\boldsymbol{H}_k+a_k \boldsymbol{z}^{(k)} \boldsymbol{z}^{(k) \top}$$
$$
\boldsymbol{H}_{k+1} \Delta \boldsymbol{g}^{(k)}=\Delta \boldsymbol{x}^{(k)}
$$
在给定 $\boldsymbol{H}_k, \Delta \boldsymbol{g}^{(k)}, \Delta \boldsymbol{x}^{(k)}$ 后, 确定 $a_k$ 和 $\boldsymbol{z}^{(k)}$ 
$$
\boldsymbol{H}_{k+1}=\boldsymbol{H}_k+\frac{\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)^{\top}}{\Delta \boldsymbol{g}^{(k) \top}\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)}
$$
- **算法步骤：**
1. 令 $k=0$; 选择初始点 $\boldsymbol{x}^{(0)}$, 任选一个对称正定实矩阵 $\boldsymbol{H}_0$ 。
2. 如果 $\boldsymbol{g}^{(k)}=\mathbf{0}$, 停止迭代; 否则, 令 $\boldsymbol{d}^{(k)}=-\boldsymbol{H}_k \boldsymbol{g}^{(k)}$ 。
3. 计算 $$\begin{aligned} 
\alpha_k =\underset{\alpha \geqslant 0}{\arg \min } f\left(\boldsymbol{x}^{(k)}+\alpha d^{(k)}\right)
\\
\boldsymbol{x}^{(k+1)} =\boldsymbol{x}^{(k)}+\alpha_k \boldsymbol{d}^{(k)}
\end{aligned}
$$
4. 计算 $\Delta \boldsymbol{x}^{(k)}=\alpha_k \boldsymbol{d}^{(k)}$
$$
\begin{aligned}
\Delta \boldsymbol{g}^{(k)} &=\boldsymbol{g}^{(k+1)}-\boldsymbol{g}^{(k)} \\
\boldsymbol{H}_{k+1} &=\boldsymbol{H}_k+\frac{\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)^{\top}}{\Delta \boldsymbol{g}^{(k) \top}\left(\Delta \boldsymbol{x}^{(k)}-\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right)}
\end{aligned}
$$
5. 令 $k:=k+1$, 回到第 2 步。

---
### DFP算法
- **秩一修正公式缺陷**
1. 秩1算法产生的矩阵 $\boldsymbol{H}_{k+1}$ 可能非正定, 将导致 $d^{(k+1)}$ 可能不是 下降方向(即使是二次型问题）。
2. 秩 1 公式的分母如果接近 0 ,会出现计算困难。
---
寻找 $\boldsymbol{F}\left(\boldsymbol{x}^{(k)}\right)^{-1}$ 的近似
具体公式:
$$
\begin{aligned}
&\Delta \boldsymbol{x}^{(k)}=\alpha_k \boldsymbol{d}^{(k)} \\
&\Delta \boldsymbol{g}^{(k)}=\boldsymbol{g}^{(k+1)}-\boldsymbol{g}^{(k)} \\
&\boldsymbol{H}_{k+1}=\boldsymbol{H}_k+\frac{\Delta \boldsymbol{x}^{(k)} \Delta \boldsymbol{x}^{(k)\top}}{\Delta \boldsymbol{x}^{(k)\top} \Delta \boldsymbol{g}^{(k)}}-\frac{\left[\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right]\left[\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}\right]^{\top}}{\Delta \boldsymbol{g}^{(k)\top} \boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}}
\end{aligned}
$$

使用秩一算法或者 $DFP$ 算法求解二次型问题时，黑塞矩阵为 $\boldsymbol{Q}=\boldsymbol{Q}^{\top}$ 有 $\boldsymbol{H}_{k+1} \Delta\boldsymbol{g}^{(i}=\Delta \boldsymbol{x}^{ (i)}$ ，$0 \le \boldsymbol{i} \le \boldsymbol{k}$ 

- **DFP算法特性**：
- 在 $DFP$ 算法中，只要矩阵 $\boldsymbol{H}_k$ 正定，$\boldsymbol{H}_{k+1}$ 就一定是正定的。 
- 当矩阵 $\boldsymbol{H}_k$ 接近为奇异矩阵时，迭代有时无法展开。

 ---
 ### BFSGS公式
- **旧思路**：根据 $\Delta \boldsymbol{g}^{(i)}=\boldsymbol{Q} \Delta \boldsymbol{x}^{(i)}, 0 \leqslant i \leqslant k$
黑塞矩阵逆矩阵的近似矩阵需要满足以下条件:
$$
\boldsymbol{H}_{k+1} \Delta \boldsymbol{g}^{(i)}=\Delta \boldsymbol{x}^{(i)}, \quad 0 \leqslant i \leqslant k
$$
基于上述等式, 可以构造黑塞矩阵逆矩阵 $Q^{-1}$ 的近似矩阵 的更新公式。
如秩1公式和DFP公式都是据此而来的。
****
- **新思路**: 除了构造 $Q^{-1}$ 的近似矩阵, 还可以构造矩阵 $Q$ 的近似矩阵
令矩阵 $B_k$ 表示在第 $k$ 次迭代中关于矩阵 $Q$ 的估计
则 $\boldsymbol{B}_{\boldsymbol{k}+1}$ 应该满足 $\Delta \boldsymbol{g}^{(i)}=\boldsymbol{B}_{k+1} \Delta \boldsymbol{x}^{(i)}, \quad 0 \leqslant i \leqslant k$
***
由DFP公式: $$\boldsymbol{H}_{k+1}^{\mathrm{DFP}}=\boldsymbol{H}_k+\frac{\Delta \boldsymbol{x}^{(k)} \Delta \boldsymbol{x}^{(k) \top}}{\Delta \boldsymbol{x}^{(k) \top} \Delta \boldsymbol{g}^{(k)}}-\frac{\boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)} \Delta \boldsymbol{g}^{(k) \top} \boldsymbol{H}_k}{\Delta \boldsymbol{g}^{(k) \top} \boldsymbol{H}_k \Delta \boldsymbol{g}^{(k)}}$$ 
用对称性，得BFGS公式
$$
\boldsymbol{B}_{k+1}=\boldsymbol{B}_k+\frac{\Delta \boldsymbol{g}^{(k)} \Delta \boldsymbol{g}^{(k) \top}}{\Delta \boldsymbol{g}^{(k) \top} \Delta \boldsymbol{x}^{(k)}}-\frac{\boldsymbol{B}_k \Delta \boldsymbol{x}^{(k)} \Delta \boldsymbol{x}^{(k) \top} \boldsymbol{B}_k}{\Delta \boldsymbol{x}^{(k) \top} \boldsymbol{B}_k \Delta \boldsymbol{x}^{(k)}}
$$
注: *DFP公式与BFGS公式称为互补的（或对偶的）*
- **BFGS公式的逆矩阵**
$$
\left(\boldsymbol{B}_{k+1}\right)^{-1}=\left(\boldsymbol{B}_k+\frac{\Delta \boldsymbol{g}^{(k)} \Delta \boldsymbol{g}^{(k) T}}{\Delta \boldsymbol{g}^{(k)\top} \Delta \boldsymbol{x}^{(k)}}-\frac{\boldsymbol{B}_k \Delta \boldsymbol{x}^{(k)} \Delta \boldsymbol{x}^{(k) \top} \boldsymbol{B}_k}{\Delta \boldsymbol{x}^{(k) \top} \boldsymbol{B}_k \Delta \boldsymbol{x}^{(k)}}\right)^{-1}
$$
原理：应用两次 [[Sherman-Morison公式]] 即可
